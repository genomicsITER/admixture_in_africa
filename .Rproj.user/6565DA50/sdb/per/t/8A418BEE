{
    "contents" : "### SCRIPT TO CALL THE VARIOUS PLOTTING SCRIPTS TO PRODUCE A SINGLE PLOT ###\nsetwd(\"~/repos/popgen/\")\n\n############################################################\n## SOURCE SOME USEFUL FUNCTIONS FROM copyselection PACKAGE ##\n## ~~~~~~~~~~~       !!! IN DEVELOPMENT !!!     ~~~~~~~~~~ ##\n############################################################\nmain_dir <- \"~/repos/\" ## where the code is kept\nsource(paste0(main_dir,\"popgen/packages_dev/functionWriter.R\"))\nsetwd(paste0(main_dir,\"popgen/\"))\n###########################################################\n## DEFINE DATAFILES\nfsanalyname <- 'MalariaGen23EthnicGroups1KGSouthAfricaNoAmericaFinalForce.A'\nleginfo_file <- \"data/MalariaGenAdmixturePopulationKey.txt\"\nmapinfo_file <- \"data/MalariaGenAdmixturePopulationKey2.txt\"\nlatlong_file <- \"data/MalariaGenAdmixturePopulationKeyLatLongs.txt\"\npoppos_file <- \"data/MalariaGenAdmixturePopulationKeyMapPositions.txt\"\npopkey_file <- \"data/MalariaGenAdmixturePopulationOverviewNSAA.txt\"\npopnums_file <- \"data/MalariaGenPopulationKeyCPanalysisPopNumbers.txt\"\npca_file <- \"data/Africa300KPCS.txt\"\ntree_file <- paste0(\"data/\",fsanalyname,\".mcmc.tree.xml\")\nmat_file <- paste0(\"data/\",fsanalyname,\"CoAncestry.txt\")\n\n## LOAD POPKEY FILE ##\npopkey <- read.table(popkey_file,header=T,as.is=T)\npopkey$Ethnic_Group <- toupper(popkey$Ethnic_Group)\n\npdf(\"figures/LocalAncestryOverview.pdf\",width=6,height=6)\n    par(mar=c(0.5,0.5,0.5,0.5))\n    layout(matrix(c(1,5,\n                    2,2,\n                    3,3,\n                    4,4),4,2,byrow=T),\n           heights=c(3,0.75,0.75,1.5),widths=c(3,3))\n           \n    ###########################################################\n    ## 00 MAP AND LEGENDS\n    transparent_cols <- FALSE ## use transparent colours for malariagen countries\n    plot_equator <- FALSE ## should equator and tropics be plotted\n    plot_ancestry_regions <- TRUE ## should countries be coloured by ancestry region or individually?\n    map_xlim<-c(-20,50) ## X-AXIS LIMITS OF MAP\n    map_ylim<-c(-32,28) ## Y-AXIS LIMITS OF MAP\n    #regions <- unique(popkey$RegionM) ## regions\n    pcolshex <- c(\"#0000CD\",\"#03B4CC\",\"#FF7F00\",\"#984EA3\",\"#FF69B4\",\"#A65628\",\"#4DAF4A\",\"#CCCC00\")\n    regions <- c(\"Western_Africa_Niger-Congo\",\"Central_West_Africa_Niger-Congo\",\n                 \"East_Africa_Niger-Congo\",\"East_Africa_Nilo-Saharan\",\"East_Africa_Afro-Asiatic\",\n                 \"South_Africa_Niger-Congo\",\"South_Africa_KhoeSan\",\"Eurasia\" )\n    map_ocean_col <- \"paleturquoise1\" ## colour of ocean in map\n    map_miss_col <- \"white\" ## colour of non-focal countries in map\n    pt_cex <- 2\n    pt_lwd <- 0.75\n    plot_legends <- FALSE\n    plot_letter <- FALSE\n    plot_points <- FALSE\n    source(\"plotting_scripts/africamap.R\")\n    ## ADD POINTS FOR COUNTRY SAMPLING POSITIONS\n    latlongs <- read.csv(latlong_file,header=T)\n    points(latlongs$Long,latlongs$Lat,pch=20,cex=1)    \n    ## ADD A LEGEND\n    legend(\"bottomleft\",legend=gsub(\"Africa \",\"\",gsub(\"\\\\_\",\" \",regions)),\n           fill=pcolshex,border=pcolshex,bty=\"n\",title=\"Ancestry Regions\")\n\n    #########################################################\n    ## 01 PLOT A PAINTED CHROMOSOME\n    library(\"rhdf5\")\n    ## FUNCTIONS\n    hap2sampleindex <- function(hap,nsamps=10){\n        ## finds the first sample index for a haplotype\n        sample <- (hap*nsamps)-(nsamps-1)\n        return(sample)\n    }\n\n    datafile <- '/mnt/kwiat/well/human/george/copy_selection/hdf5files/MalariaGenSelectionPaintings.hdf5'\n    ## CHROMOSOME 2\n    chrom <- \"02\"\n    ## GET MAP AND POSITION INFO\n    map <- data.frame(t(h5read(datafile,paste0(\"/paintings/chrom\",chrom,\"/map\"))))\n    H5close()\n    colnames(map) <- c(\"position\",\"recrate\")\n    ## GET 10X SAMPLES OF A SINGLE PAINTED CHROMOSOME\n    psamples <- t(h5read(datafile,paste0(\"/paintings/samples/individuals\")))\n    H5close()\n    colnames(psamples) <- c(\"ind\",\"region\",\"X\")\n    psamplesind <- (1:nrow(psamples))[psamples[,\"ind\"] == \"FULA_S3\"]\n    ## 2 haps per sample!!\n    psampleshap <- hap2sampleindex(psamplesind,2)\n    psamplesindsamp <- hap2sampleindex(psampleshap)\n    \n    for(analysis in c(\"local\",\"nonlocal\"))\n    {\n        tmp <- psamplesindsamp:(psamplesindsamp+9)\n        paintedchrom <- h5read(datafile,paste0(\"/paintings/chrom\",chrom,\"/\",analysis),\n                               index=list(tmp,1:nrow(map)))\n        H5close()\n        ## SWITCH DONORS TO REGIONS\n        happops <- c()\n        for(i in 1:nrow(psamples)) happops <- c(happops,rep(as.character(psamples[i,\"region\"]),2))\n        happops <- gsub(\"SEMI.BANTU\",\"SEMI-BANTU\",happops)\n        hapregs <- c()\n        for(i in happops) hapregs <- c(hapregs,as.character(popkey$RegionM[popkey$Ethnic_Group==i]))\n        hapregs <- factor(hapregs,levels=ancreg_list)\n        paintedchromreg <- matrix(nc=ncol(paintedchrom),nr=nrow(paintedchrom))\n        for(i in 1:nrow(paintedchrom)) paintedchromreg[i,] <- hapregs[paintedchrom[i,]]\n        ## NOW GET PROPOTION OF ANCESTRY AT EACH SNP\n        paintedchromregprop <- matrix(0,nr=length(ancreg_list),nc=ncol(paintedchromreg))\n        for(i in 1:ncol(paintedchromreg))\n        {\n            print(i)\n            tmp <- table(paintedchromreg[,i])\n            paintedchromregprop[as.numeric(names(tmp)),i] <- tmp\n        }\n    \n        ## BAR WIDTHS\n        chromlength <- as.numeric(as.character(map$recrate))\n        chrompos <- as.numeric(as.character(map$position))\n        chromposI <- c(diff(chrompos),0)\n        chrom2plot <- paintedchromregprop[8:1,]\n       #chrom2plot <- t(apply(chrom2plot,2,which.max))\n    \n        if(analysis == \"local\") par(mar=c(0.5,1,1.5,1))\n        if(analysis == \"nonlocal\") par(mar=c(0.5,1,1.5,1))\n        barplot(chrom2plot,\n                width=chromposI,\n                col=rev(pcolshex),xaxs=\"i\",yaxs=\"i\",\n                space=0,axes=F,xaxt=\"n\",border=NA,\n                xlim=c(0,sum(chromposI)),\n                xlab=\"\")\n        mtext(3,text=paste(analysis,\"painting of a Fulani individual: one haplotype x 10 samples\"),\n              line=0.5,cex=0.75)\n    }\n\n    ## NOW SHOW PAINTINGS ACROSS ALL FULAI\n        psamplesind <- (1:nrow(psamples))[psamples[,\"region\"] == \"FULAI\"]\n        ## 2 haps per sample!!\n        psampleshap <- hap2sampleindex(psamplesind,2)\n        psampleshap <- sort(c(psampleshap,psampleshap+1))\n        psamplesindsamp <- hap2sampleindex(psampleshap)\n        tmp <- c()\n        for(i in psamplesindsamp) tmp <- c(tmp,i:(i+9))\n        paintedchrom <- h5read(datafile,paste0(\"/paintings/chrom\",chrom,\"/nonlocal\"),\n                               index=list(tmp,1:nrow(map)))\n        H5close()\n        ## SWITCH DONORS TO REGIONS\n        happops <- c()\n        for(i in 1:nrow(psamples)) happops <- c(happops,rep(as.character(psamples[i,\"region\"]),2))\n        happops <- gsub(\"SEMI.BANTU\",\"SEMI-BANTU\",happops)\n        hapregs <- c()\n        for(i in happops) hapregs <- c(hapregs,as.character(popkey$RegionM[popkey$Ethnic_Group==i]))\n        hapregs <- factor(hapregs,levels=ancreg_list)\n        paintedchromreg <- matrix(nc=ncol(paintedchrom),nr=nrow(paintedchrom))\n        for(i in 1:nrow(paintedchrom)) paintedchromreg[i,] <- hapregs[paintedchrom[i,]]\n        ## NOW GET PROPOTION OF ANCESTRY AT EACH SNP\n        paintedchromregprop <- matrix(0,nr=length(ancreg_list),nc=ncol(paintedchromreg))\n        for(i in 1:ncol(paintedchromreg))\n        {\n            print(i)\n            tmp <- table(paintedchromreg[,i])\n            paintedchromregprop[as.numeric(names(tmp)),i] <- tmp\n        }\n        \n        ## BAR WIDTHS\n        chromlength <- as.numeric(as.character(map$recrate))\n        chrompos <- as.numeric(as.character(map$position))\n        chromposI <- c(diff(chrompos),0)\n        chrom2plot <- paintedchromregprop[8:1,]\n        #chrom2plot <- t(apply(chrom2plot,2,which.max))\n        \n        par(mar=c(3,1,2,1))\n        barplot(chrom2plot,\n                width=chromposI,\n                col=rev(pcolshex),xaxs=\"i\",yaxs=\"i\",\n                space=0,axes=F,xaxt=\"n\",border=NA,\n                xlim=c(0,sum(chromposI)),\n                xlab=\"\")\n        mtext(3,text=paste(\"all nonlocal paintings of 72 Fulani individuals\"),line=0.5,cex=0.75)\n        xat <- pretty(chrompos)\n        xat[length(xat)] <- sum(chromposI)\n        axis(1,at=xat,labels=round(xat/1e6))\n        mtext(1,text=paste(\"position on chromosome\",as.numeric(chrom)),line=2,cex=0.75)\n\n        ## FILLER\n        par(mar=c(0,0.5,0,0))\n        plot(0,0,xlab=\"\",ylab=\"\",type=\"n\",axes=F)\n        mtext(2,text=\"ARG?\",cex=5,las=1,adj=0)\n\ndev.off()",
    "created" : 1455872393524.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2368789502",
    "id" : "8A418BEE",
    "lastKnownWriteTime" : 1453201642,
    "path" : "~/repos/popgen/plotting_scripts/plotAfricaMapLocalAncestry.R",
    "project_path" : "plotting_scripts/plotAfricaMapLocalAncestry.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_source"
}